### 小程序视频播放指南

#### 前言

海康云曜开放能力分为基础能力和业务组件两部分，其中面向细分业务场景物联网IOT、视频服务，提供微信端小程序视频播放能力。

#### 背景

在市场中，各种物联设备接入中，根据不同类型的视频设备，有很多不同的码流播放协议，例如有RTSP，RTMP，FLV、HLS以及EZOPEN等私有协议。在微信小程序官方文档中，可查询到支持的播放协议有三种，分别是RTMP、FLV以及HLS。

#### 视频协议

在所有协议中RTMP与FLV是“近亲”关系，FLV文件是由FLV Header + RTMP数据构成的，即 FLV 是在 RTMP 数据之上加了一层“⻢甲”。所以在微信小程序中，他们可以看作是一种协议。

RTMP协议：`rtmp://rtmp.open.ys7.com/openlive/设备ID[.清晰度]`

FLV协议：`https://rtmp01open.ys7.com/openlive/设备ID[.清晰度]`

RTMP 是专为流媒体开发的协议，对底层的优化比其它协议更加优秀，基本上所有的编码器（摄像头之类）都支持 RTMP 输出。同时在PC 上 Windows的浏览器基本上都支持，而且RTMP 的延迟相对较低，一般延时在 1-3s 之间，一般的视频会议，互动式直播，视频预览都能够支持。所以小程序推出了**live-player**组件播放这两种协议的码流。 

相对于常见的流媒体协议，HLS 最大的不同在于它并不是一下请求完整的数据流。它会在服务器端将流媒体数据切割成连续的时长较短的 ts 小文件，并通过M3U8 索引文件按序访问 ts 文件。客户端只要不停的按序播放从服务器获取到的文件，从而实现播放音视频。 HLS 在 HTML5 页面上实现播放非常简单，同样在小程序种播放也很简单，直接使用小程序基础媒体组件**video**播放。

HLS协议：`http://hls.open.ys7.com/openlive/设备ID[.清晰度].m3u8`

#### 小程序组件

以上可知：小程序中RTMP/FLV协议的视频播放，采用**live-player**组件，它的主要场景是用于视频预览，直播，会议等，基于互联网管理，微信对它做出相当大的限制，将在下一节live-player视频播放中提到。而HLS协议则采用**video**组件，但video组件播放M3U8 格式文件会有延迟，最优情况会延迟3~8秒，较差的情况会在12~20秒。

#### 视频播放

基于以上，海康云曜开放能力，提供小程序视频播放主要支持RTMP、FLV、HLS三种协议，live-player与video两种组件播放方式。当前主要支持视频预览，回放能力将在后续开放。

